---
title: "Data relations"
---

```{r opts, echo = FALSE}
#suppress the warnings and other messages from showing in the knitted file.
knitr::opts_chunk$set(
  fig.width  = 8, 
  fig.height = 5, 
  fig.path   = 'images/05/',
  echo       = TRUE, 
  warning    = FALSE, 
  message    = FALSE
)
```

## Learning Objectives {.tabset}

### Basic

1. Be able to use the 4 mutating join verbs:
    + `left_join()`
    + `right_join()`
    + `inner_join()`
    + `outer_join()`
    
2. Be able to use the 2 binding join verb:
    + `bind_rows()`
    + `bind_cols()`

### Intermediate

2. Be able to use the 2 filtering join verbs:
    + `semi_join()`
    + `anti_join()`

### Advanced

3. Be able to use the 3 set operations:
    + `intersect()`
    + `union()`
    + `setdiff()`
    

## Prep

* Read [Chapter 13: Relational Data](http://r4ds.had.co.nz/relational-data.html) in *R for Data Science*


## Resources

* [Cheatsheet for dplyr join functions](http://stat545.com/bit001_dplyr-cheatsheet.html#full_joinsuperheroes-publishers)


## Examples

```{r}

# libraries needed for these graphs
library(tidyverse)
library(readxl)

```

### Load and process data

These data and cleaning code are from [Data cleaning](02_tidyr.html)

```{r}

# load country data from a CSV file on the web
ccodes <- read_csv("https://raw.githubusercontent.com/lukes/ISO-3166-Countries-with-Regional-Codes/master/all/all.csv")

infmort <- read_csv("data/infmort.csv") %>%  # load infant mortality data from a CSV file
  separate(                                  # separate the stats column into its 3 parts
    3, 
    c("rate", "ci_low", "ci_hi"), 
    extra = "drop", 
    sep = "(\\[|-|])", 
    convert = TRUE
  )

matmort <- read_xls("data/matmort.xls") %>%   # load maternal mortality data from an excel file
  gather("Year", "stats", `1990`:`2015`) %>%  # convert to long format
  mutate(stats = gsub(" ", "", stats)) %>%    # get rid of spaces in stats column
  separate(                                   # separate the stats column into its 3 parts
    stats, 
    c("rate", "ci_low", "ci_hi"), 
    extra = "drop", 
    convert = TRUE
  )

```

### inner_join()

`inner_join(x, y, by = NULL, suffix = c(".x", ".y")`

Use an `inner_join()` if you only want matching data between two tables and want 
to exclude any data from either table that doesn't have a match in the other table.

* x = the first table (order doesn't matter here)
* y = the second table (order doesn't matter here)
* by = what columns to match on. If you leave this blank, it will match on any columns with the same names in the two tables.
* suffix = if columns have the same name in the two tables, but you aren't joining by them, they get a suffix to make them unambiguous. This defaults to ".x" and ".y", but you can change it to something more meaningful.

```{r}

#infmatmort <- inner_join(matmort, infmort, by = c("Country", "Year"))

```

<pre><code>Error in inner_join_impl(x, y, by$x, by$y, suffix$x, suffix$y, check_na_matches(na_matches)) : 
  Can't join on 'Year' x 'Year' because of incompatible types (character / integer)</code></pre>

#### Incompatible tpyes

Oops. `Year` is an integer type in `nfmort` and a character type in `matmort`. 
We can fix that by adding `convert = TRUE` to the `gather` function.

```{r}

matmort <- read_xls("data/matmort.xls") %>%   
  gather("Year", "stats", `1990`:`2015`, convert = TRUE) %>%
  mutate(stats = gsub(" ", "", stats)) %>%
  separate(
    stats, 
    c("rate", "ci_low", "ci_hi"), 
    extra = "drop", 
    convert = TRUE
  )

infmatmort <- inner_join(matmort, infmort, by = c("Country", "Year"))

glimpse(infmatmort)

```

#### Disambiguate duplicate column names with `suffix`

Maybe we shouldn't have given the rates and CIs the same names in the infant and 
maternal mortality tables if we were going to join them. We could fix that by 
changing the names in the `separate` functions to be unique. Here, we'll add the 
suffixes "_mat" and "_inf" to distinguish them.

```{r}

infmatmort <- inner_join(
  matmort, 
  infmort, 
  by = c("Country", "Year"),
  suffix = c("_mat", "_inf")
)

glimpse(infmatmort)

```

### left_join()

`left_join(x, y, by = NULL, suffix = c(".x", ".y")`

Use a `left_join()` if you want to keep all the data in the main (x, left) table 
and join data from another (y, right) table if it exists.

<p class="fyi">Notice by = c("Country" = "name")</p>


```{r}
infmatmort_region <- infmatmort %>%
  left_join(ccodes, by = c("Country" = "name"))

glimpse(infmatmort_region)
```

### Unwanted columns

`right_join(optional.data, main.data, by = c("opt.col" = "main.col")`

We really just wanted the region, not all the extra data from the country codes. 
We can just select the columns we want when we load the country codes data. 
If we start with the `ccodes` table, we can `right_join()` the `infmatmort` table, 
which is just the opposite of a left join (keeps all the data from the "right" joined 
table and any data from the "left" table that matches). Remember to switch the 
order of the `by` columns if they have different names in the main and optional data tables.

```{r}

infmatmort_region <- read_csv("https://raw.githubusercontent.com/lukes/ISO-3166-Countries-with-Regional-Codes/master/all/all.csv") %>%
  select(name, region) %>%
  right_join(infmatmort, by = c("name" = "Country"))

infmatmort_region[1:5, ]

```


### Plot maternal vs infant mortality by region

So let's make a graph that we couldn't have easily made with 3 separate data tables

```{r}
infmatmort_region %>%
  group_by(name, region) %>%
  summarise(
    matmort = mean(rate_mat),
    infmort = mean(rate_inf)
  ) %>%
  ggplot(aes(infmort, matmort, colour = region)) +
  geom_smooth(method = "lm") +
  geom_point() +
  facet_grid(.~region)
```






---
title: "Data relations"
---

```{r opts, echo = FALSE}
#suppress the warnings and other messages from showing in the knitted file.
knitr::opts_chunk$set(
  fig.width  = 8, 
  fig.height = 5, 
  fig.path   = 'images/05/',
  echo       = TRUE, 
  warning    = FALSE, 
  message    = FALSE
)
```

## Learning Objectives {.tabset}

### Basic

1. Be able to use the 4 mutating join verbs:
    + `left_join()`
    + `right_join()`
    + `inner_join()`
    + `outer_join()`
    
2. Be able to use the 2 binding join verb:
    + `bind_rows()`
    + `bind_cols()`

### Intermediate

2. Be able to use the 2 filtering join verbs:
    + `semi_join()`
    + `anti_join()`

### Advanced

3. Be able to use the 3 set operations:
    + `intersect()`
    + `union()`
    + `setdiff()`
    

## Prep

* Read [Chapter 13: Relational Data](http://r4ds.had.co.nz/relational-data.html) in *R for Data Science*


## Resources

* [Cheatsheet for dplyr join functions](http://stat545.com/bit001_dplyr-cheatsheet.html#full_joinsuperheroes-publishers)


## Examples

```{r}

# libraries needed for these graphs
library(tidyverse)
library(readxl)

```

### Load and process data

These data and cleaning code are from [Data cleaning](02_tidyr.html)

```{r}

ccodes <- read_csv("https://raw.githubusercontent.com/lukes/ISO-3166-Countries-with-Regional-Codes/master/all/all.csv")

infmort <- read_csv("data/infmort.csv") %>%
  separate(3, c(c("rate", "ci_low", "ci_hi")), sep = "(\\[|-)|]") %>%
  mutate(
    rate = as.numeric(rate),
    ci_low = as.numeric(ci_low),
    ci_hi = as.numeric(ci_hi)
  )

matmort <- read_xls("data/matmort.xls") %>%
  gather("Year", "stats", `1990`:`2015`) %>%
  mutate(stats = gsub(" ", "", stats)) %>%
  separate(stats, c("rate", "ci_low", "ci_hi")) %>%
  mutate(
    Year = as.integer(Year),
    rate = as.numeric(rate),
    ci_low = as.numeric(ci_low),
    ci_hi = as.numeric(ci_hi)
  )

```

### Join the data by Country and Year

inner_join(data1, data2, by = c("col1", "col2"))

Use an `inner_join()` if you only want matching data between 
two tables and want to exclude any data from either table 
that doesn't have a match in the other table.

```{r}

inf.mat.mort <- inner_join(matmort, infmort, by = c("Country", "Year"))

inf.mat.mort[1:5, ]

```

### Duplicate column names

Maybe we shouldn't have given the rates and CIs the same 
names in the infant and maternal mortality tables if we 
were going to join them. That's easily fixed.

```{r}

infmort <- read_csv("data/infmort.csv") %>%
  separate(3, c(c("infmort_rate", "infmort_ci_low", "infmort_ci_hi")), sep = "(\\[|-)|]") %>%
  mutate(
    infmort_rate = as.numeric(infmort_rate),
    infmort_ci_low = as.numeric(infmort_ci_low),
    infmort_ci_hi = as.numeric(infmort_ci_hi)
  )

matmort <- read_xls("data/matmort.xls") %>%
  gather("Year", "stats", `1990`:`2015`) %>%
  mutate(stats = gsub(" ", "", stats)) %>%
  separate(stats, c("matmort_rate", "matmort_ci_low", "matmort_ci_hi")) %>%
  mutate(
    Year = as.integer(Year),
    matmort_rate = as.numeric(matmort_rate),
    matmort_ci_low = as.numeric(matmort_ci_low),
    matmort_ci_hi = as.numeric(matmort_ci_hi)
  )

inf.mat.mort <- inner_join(matmort, infmort, by = c("Country", "Year"))

inf.mat.mort[1:5, ]

```

### Join the region from the country codes

`left_join(main.data, optional.data, by = c("main.col" = "opt.col")`

Use a `left_join()` if you want to keep all the data in the main 
(left) table and join data from another (right) table if it exists.


```{r}
inf.mat.mort.region <- inf.mat.mort %>%
  left_join(ccodes, by = c("Country" = "name"))

inf.mat.mort.region[1:5, ]
```

### Unwanted columns

`right_join(optional.data, main.data, by = c("opt.col" = "main.col")`

We really just wanted the region, not all the extra data from the country codes. 
We can just select the columns we want when we load the country codes data. 
If we start with the `ccodes` table, we can `right_join()` the `inf.mat.mort` table, 
which is just the opposite of a left join (keeps all the data from the "right" joined 
table and any data from the "left" table that matches). Remember to switch the 
order of the `by` columns if they have different names in the main and optional data tables.

```{r}

inf.mat.mort.region <- read_csv("https://raw.githubusercontent.com/lukes/ISO-3166-Countries-with-Regional-Codes/master/all/all.csv") %>%
  select(name, region) %>%
  right_join(inf.mat.mort, by = c("name" = "Country"))

inf.mat.mort.region[1:5, ]

```


### Plot maternal vs infant mortality by region

So let's make a graph that we couldn't have easily made with 3 separate data tables

```{r}
inf.mat.mort.region %>%
  group_by(name, region) %>%
  summarise(
    matmort = mean(matmort_rate),
    infmort = mean(infmort_rate)
  ) %>%
  ggplot(aes(infmort, matmort, colour = region)) +
  geom_smooth(method = "lm") +
  geom_point() +
  facet_grid(.~region)
```





